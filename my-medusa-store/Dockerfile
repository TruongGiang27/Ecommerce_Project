# Stage 1: Build
FROM node:20-alpine AS builder

WORKDIR /app

# CÃ i Ä‘áº·t cÃ¡c thÆ° viá»‡n cáº§n thiáº¿t
RUN apk add --no-cache libc6-compat python3 make g++

COPY package.json package-lock.json ./

# CÃ i Ä‘áº·t dependencies
RUN npm ci

COPY . .

# Build Medusa
RUN npm run build

# Stage 2: Production Runner
FROM node:20-alpine AS runner

WORKDIR /app

ENV NODE_ENV=production

# CÃ i libc6-compat
RUN apk add --no-cache libc6-compat

# Copy node_modules vÃ  source Ä‘Ã£ build tá»« builder
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/.medusa ./.medusa
COPY --from=builder /app/package.json ./package.json

# Copy file config
COPY --from=builder /app/medusa-config.ts ./medusa-config.ts

# ğŸ‘‡ğŸ‘‡ğŸ‘‡ DÃ’NG NÃ€Y LÃ€ DÃ’NG Báº N ÄANG THIáº¾U ğŸ‘‡ğŸ‘‡ğŸ‘‡
COPY --from=builder /app/tsconfig.json ./tsconfig.json

# Port máº·c Ä‘á»‹nh
EXPOSE 9000

# Lá»‡nh cháº¡y server
CMD ["npm", "run", "start"]