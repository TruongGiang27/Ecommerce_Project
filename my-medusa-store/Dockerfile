# Stage 1: Build
FROM node:20-alpine AS builder

WORKDIR /app

# CÃ i Ä‘áº·t thÆ° viá»‡n há»‡ thá»‘ng
RUN apk add --no-cache libc6-compat python3 make g++

COPY package.json package-lock.json ./

# CÃ i Ä‘áº·t dependencies
RUN npm ci

COPY . .

# Build Medusa (Admin sáº½ Ä‘Æ°á»£c táº¡o ra táº¡i .medusa/client)
RUN npm run build

# Stage 2: Production Runner
FROM node:20-alpine AS runner

WORKDIR /app

ENV NODE_ENV=production

# CÃ i libc6-compat
RUN apk add --no-cache libc6-compat

# Copy node_modules
COPY --from=builder /app/node_modules ./node_modules

# Copy Backend Core (.medusa chá»©a .medusa/server vÃ  .medusa/client)
COPY --from=builder /app/.medusa ./.medusa
COPY --from=builder /app/package.json ./package.json

# Copy Config
COPY --from=builder /app/medusa-config.ts ./medusa-config.ts
COPY --from=builder /app/tsconfig.json ./tsconfig.json

# Táº¡o thÆ° má»¥c public rá»—ng (trÃ¡nh lá»—i not found)
RUN mkdir -p public

# ğŸ‘‡ğŸ‘‡ğŸ‘‡ CHIáº¾N THUáº¬T Ráº¢I THáº¢M: COPY VÃ€O Má»ŒI CHá»– CÃ“ THá»‚ ğŸ‘‡ğŸ‘‡ğŸ‘‡

# 1. Copy vÃ o thÆ° má»¥c gá»‘c /app/build (NÆ¡i Medusa thÆ°á»ng tÃ¬m nháº¥t)
COPY --from=builder /app/.medusa/client ./build

# 2. Copy vÃ o thÆ° má»¥c /app/.medusa/admin (NÆ¡i cáº¥u trÃºc Medusa v2 Ä‘Ã´i khi tÃ¬m)
# Lá»‡nh nÃ y sáº½ tá»± táº¡o thÆ° má»¥c admin náº¿u chÆ°a cÃ³
COPY --from=builder /app/.medusa/client ./.medusa/admin

# Port
EXPOSE 9000

# Cháº¡y server
CMD ["npm", "run", "start"]