# --- Stage 1: Build ---
FROM node:20-alpine AS builder

WORKDIR /app

# CÃ i Ä‘áº·t thÆ° viá»‡n há»‡ thá»‘ng cáº§n thiáº¿t
RUN apk add --no-cache libc6-compat python3 make g++

# Copy package files
COPY package.json package-lock.json ./

# CÃ i Ä‘áº·t dependencies
RUN npm ci

# Copy toÃ n bá»™ source code
COPY . .

# Build Medusa (Admin sáº½ Ä‘Æ°á»£c táº¡o ra táº¡i .medusa/client)
RUN npm run build

# --- Stage 2: Production Runner ---
FROM node:20-alpine AS runner

WORKDIR /app

ENV NODE_ENV=production

# CÃ i libc6-compat
RUN apk add --no-cache libc6-compat

# 1. Copy node_modules
COPY --from=builder /app/node_modules ./node_modules

# 2. Copy Backend Core (.medusa chá»©a code server)
COPY --from=builder /app/.medusa ./.medusa
COPY --from=builder /app/package.json ./package.json

# 3. Copy Configs
COPY --from=builder /app/medusa-config.ts ./medusa-config.ts
COPY --from=builder /app/tsconfig.json ./tsconfig.json

# 4. Táº¡o cÃ¡c thÆ° má»¥c Ä‘Ã­ch trÆ°á»›c Ä‘á»ƒ trÃ¡nh lá»—i
RUN mkdir -p build && mkdir -p public && mkdir -p .medusa/server/public/admin

# ğŸ‘‡ğŸ‘‡ğŸ‘‡ Sá»¬A Lá»–I QUAN TRá»ŒNG: COPY ADMIN VÃ€O 2 CHá»– ğŸ‘‡ğŸ‘‡ğŸ‘‡

# Chá»— 1: Copy vÃ o /app/build (NÆ¡i server thÆ°á»ng tÃ¬m kiáº¿m máº·c Ä‘á»‹nh vÃ  bÃ¡o lá»—i)
COPY --from=builder /app/.medusa/client ./build

# Chá»— 2: Copy vÃ o cáº¥u trÃºc ná»™i bá»™ cá»§a Medusa v2 (Dá»± phÃ²ng)
COPY --from=builder /app/.medusa/client ./.medusa/server/public/admin

# Port
EXPOSE 9000

# Cháº¡y server
CMD ["npm", "run", "start"]