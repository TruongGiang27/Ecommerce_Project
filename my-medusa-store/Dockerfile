# Stage 1: Build
FROM node:20-alpine AS builder

WORKDIR /app

# CÃ i Ä‘áº·t thÆ° viá»‡n há»‡ thá»‘ng
RUN apk add --no-cache libc6-compat python3 make g++

COPY package.json package-lock.json ./

# CÃ i Ä‘áº·t dependencies
RUN npm ci

COPY . .

# Build Medusa (Táº¡o ra folder .medusa chá»©a má»i thá»©)
RUN npm run build

# Stage 2: Production Runner
FROM node:20-alpine AS runner

WORKDIR /app

ENV NODE_ENV=production

# CÃ i libc6-compat
RUN apk add --no-cache libc6-compat

# Copy node_modules
COPY --from=builder /app/node_modules ./node_modules

# Copy Backend Core (Copy TRá»ŒN GÃ“I folder .medusa Ä‘á»ƒ khÃ´ng sÃ³t file nÃ o)
COPY --from=builder /app/.medusa ./.medusa
COPY --from=builder /app/package.json ./package.json

# Copy Config
COPY --from=builder /app/medusa-config.ts ./medusa-config.ts
COPY --from=builder /app/tsconfig.json ./tsconfig.json

# Táº¡o thÆ° má»¥c build vÃ  public rá»—ng trÆ°á»›c
RUN mkdir -p build && mkdir -p public

# Port
EXPOSE 9000

# ğŸ‘‡ğŸ‘‡ğŸ‘‡ CHIáº¾N THUáº¬T QUAN TRá»ŒNG NHáº¤T ğŸ‘‡ğŸ‘‡ğŸ‘‡
# Lá»‡nh nÃ y lÃ m 3 viá»‡c:
# 1. In ra mÃ n hÃ¬nh xem file index.html Ä‘ang trá»‘n á»Ÿ Ä‘Ã¢u (Ä‘á»ƒ debug náº¿u cáº§n)
# 2. Copy folder .medusa/client (nÆ¡i chá»©a Admin) ra folder build (nÆ¡i Server cáº§n)
# 3. Cháº¡y Server
CMD ["sh", "-c", "echo 'Searching for Admin...' && ls -R .medusa | grep index.html && cp -r .medusa/client/* build/ && echo 'Admin copied to build!' && npm run start"]